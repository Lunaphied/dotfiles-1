#!/bin/sh
set -eu

if [[ $# -lt 1 ]]; then
    echo "usage: git-linear TEAM-123"
    exit 1
fi

APIKEY="$(security find-generic-password -w -a $LOGNAME -s linear-apikey)"
QUERY="$(cat <<EOF
query {
  issue(id: "$1") {
    branchName
  }
}
EOF
)"

branchname="$(curl \
    -s \
    -X POST \
    -H 'Content-Type: application/json' \
    -H "Authorization: $APIKEY" \
    --data "$(jq --null-input --arg q "$QUERY" '{} | .query = $q')" \
    https://api.linear.app/graphql \
    | jq -r .data.issue.branchName
)"

git switch -c $branchname "$@"
