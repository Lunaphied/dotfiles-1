#!/bin/zsh

WIRELESS_DEVICE=wls3
ETHERNET_DEVICE=ens2
BATT_SYSFS=/sys/devices/platform/smapi/BAT0
PANEL_FIFO=/tmp/panel-fifo
PANEL_HEIGHT=20
PANEL_FONT="xft:CamingoCode:size=9"
ICON_FONT="FontAwesome:size=11"
GET_ESSID="get_essid $WIRELESS_DEVICE | tr -d '\n'"
source `which panel_config`

if [[ $(pgrep -cx panel) > 1 ]]; then
	echo "Panel already running." >&2
	exit 1
fi

get_time_from_minutes() {
	min=$1
	(( hr = min / 60 ))
	(( rmin = min % 60 ))
	printf "%d:%02d" ${hr} ${rmin}
}

trap 'exit 0' INT TERM QUIT EXIT

[[ -e "$PANEL_FIFO" ]] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"

bspc config top_padding $PANEL_HEIGHT
bspc control --subscribe > "$PANEL_FIFO" &

xtitle -sf 'T%s' > $PANEL_FIFO &

while true; do
	echo 'C\uf017' $(date +"%b %d %H:%M")
	sleep $((60 - $(date +%s) % 60))
done > $PANEL_FIFO &

while true; do
	# super simple battery handling for thinkpads only
	power_str="P\uf0e7 "
	percent_remaining="$(cat $BATT_SYSFS/remaining_percent)"
	icons=(
		"$power_str %{Fred}\uf244%{F-}"
		"$power_str \uf243"
		"$power_str \uf242"
		"$power_str \uf241"
		"$power_str \uf240"
	)
	power_str=$icons[$(($percent_remaining / 20))]
	rtmin=$(cat $BATT_SYSFS/remaining_running_time)
	if [[ $rtmin != "not_discharging" ]]; then
		rtstr="($(get_time_from_minutes $rtmin) rt)"
	else
		rtstr=""
	fi
	power_str="$power_str $percent_remaining%${rtstr}"

	if [[ "$(cat /sys/devices/platform/smapi/ac_connected)" == 1 ]]; then
		chargetime=$(cat $BATT_SYSFS/remaining_charging_time)
		if [[ "$chargetime" != not_charging ]]; then
			chgt=$(get_time_from_minutes chargetime)
			power_str="$power_str ($chgt chg time)"
		fi
		power_str="${power_str} \uf1e6"
	fi
	echo "$power_str"
	sleep 10
done > $PANEL_FIFO &

while true; do
	net_str='N\uf0ac'

	if [[ "$(cat /sys/class/net/$WIRELESS_DEVICE/operstate)" == "up" ]]; then
		net_str="$net_str \uf1eb $($GET_ESSID)"
		WIFI_UP=1
	else
		WIFI_UP=0
	fi

	if [[ "$(cat /sys/class/net/$ETHERNET_DEVICE/operstate)" == "up" ]]; then
		net_str="$net_str \uf0c1"
		ETHERNET_UP=1
	else
		ETHERNET_UP=0
	fi

	if [[ "$WIFI_UP" == 0 && "$ETHERNET_UP" == 0 ]]; then
		net_str="$net_str -"
	fi

	echo "$net_str"
	sleep 10
done > $PANEL_FIFO &

cat "$PANEL_FIFO" | panel_bar | lemonbar "-f$PANEL_FONT" "-f$ICON_FONT" -gx$PANEL_HEIGHT
wait
