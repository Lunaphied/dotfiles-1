#!/bin/zsh

WIRELESS_DEVICE=wls3
ETHERNET_DEVICE=ens2
BATT_SYSFS=/sys/devices/platform/smapi/BAT0
PANEL_FIFO=/tmp/panel-fifo
PANEL_HEIGHT=20
PANEL_FONT="xft:CamingoCode:size=9"
ICON_FONT="FontAwesome:size=11"

if [[ $(pgrep -cx panel) -gt 1 ]]; then
	printf "%s\n" "Panel already running." >&2
	exit 1
fi

get_time_from_minutes() {
	running_time_min=$1
	(( running_time_hr = running_time_min / 60 ))
	(( running_time_rmin = running_time_min % 60 ))
	if [[ running_time_rmin == 0 ]]; then
		running_time_rmin="00"
	fi
	echo -n "${running_time_hr}:${running_time_rmin}"
}

trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

[[ -e "$PANEL_FIFO" ]] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"

bspc config top_padding $PANEL_HEIGHT
bspc control --subscribe > "$PANEL_FIFO" &

xtitle -sf 'T%s' > $PANEL_FIFO &

while true; do
	echo 'C\uf017' $(date +"%b %d %H:%M")
	sleep 5
done > $PANEL_FIFO &

while true; do
	# super simple battery handling for thinkpads only
	power_str="P\uf0e7 "
	percent_remaining="$(cat $BATT_SYSFS/remaining_percent)"
	if (( $percent_remaining > 75 )); then
		power_str="$power_str \uf240"
	fi
	if (( $percent_remaining <= 75 && $percent_remaining > 50 )); then
		power_str="$power_str \uf241"
	fi
	if (( $percent_remaining <= 50 && $percent_remaining > 25 )); then
		power_str="$power_str \uf242"
	fi
	if (( $percent_remaining <= 25 && $percent_remaining > 10 )); then
		power_str="$power_str \uf243"
	fi
	if (( $percent_remaining <= 10 )); then
		power_str="$power_str %{Fred}\uf244%{F-}"
	fi
	rtmin=$(cat $BATT_SYSFS/remaining_running_time)
	if [[ $rtmin != "not_discharging" ]]; then
		rtstr="($(get_time_from_minutes $rtmin) rt)"
	else
		rtstr=""
	fi
	power_str="$power_str $percent_remaining%${rtstr}"

	if [[ "$(cat /sys/devices/platform/smapi/ac_connected)" == 1 ]]; then
		chargetime=$(cat $BATT_SYSFS/remaining_charging_time)
		if [[ "$chargetime" != not_charging ]]; then
			chgt=$(get_time_from_minutes chargetime)
			power_str="$power_str ($chgt chg time)"
		fi
		power_str="${power_str} \uf1e6"
	fi
	echo "$power_str"
	sleep 20
done > $PANEL_FIFO &

while true; do
	net_str='N\uf0ac'

	if [[ "$(cat /sys/class/net/$WIRELESS_DEVICE/operstate)" == "up" ]]; then
		net_str="$net_str \uf1eb $(get_essid $WIRELESS_DEVICE | tr -d '\n')"
		WIFI_UP=1
	else
		WIFI_UP=0
	fi

	if [[ "$(cat /sys/class/net/$ETHERNET_DEVICE/operstate)" == "up" ]]; then
		net_str="$net_str \uf0c1"
		ETHERNET_UP=1
	else
		ETHERNET_UP=0
	fi

	if [[ "$WIFI_UP" == 0 && "$ETHERNET_UP" == 0 ]]; then
		net_str="$net_str -"
	fi

	echo "$net_str"
	sleep 10
done > $PANEL_FIFO &

cat "$PANEL_FIFO" | panel_bar | lemonbar "-f$PANEL_FONT" "-f$ICON_FONT" -gx$PANEL_HEIGHT
wait
